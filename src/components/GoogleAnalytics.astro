---
interface Props {
  /**
   * Google Analytics 4 Measurement ID (e.g., "G-XXXXXXXXXX")
   * Get this from your GA4 property settings
   */
  gaId?: string;
}

const { gaId } = Astro.props;

if (!gaId) {
  console.warn('GoogleAnalytics: gaId prop is required. Analytics will not be initialized.');
}
---

{
  gaId && (
    <>
      <!-- Google Analytics -->
      <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}></script>
      <script>
        const gaId = import.meta.env.PUBLIC_GA_ID;

        // Initialize GA data layer
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          window.dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', gaId, {
          'allow_google_signals': true,
          'allow_ad_personalization_signals': true,
        });

        // Track pageviews on initial load and View Transitions
        document.addEventListener('astro:page-load', () => {
          gtag('event', 'page_view', {
            'page_path': window.location.pathname + window.location.search,
            'page_title': document.title,
          });
        });

        // Fallback: Track pageview when tab becomes visible
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible') {
            gtag('event', 'page_view', {
              'page_path': window.location.pathname + window.location.search,
              'page_title': document.title,
            });
          }
        });
      </script>
    </>
  )
}
